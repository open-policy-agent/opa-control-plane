cases:
- note: config without git
  config: |
        {
          bundles: {
            TestSystem: {
              object_storage: {
                aws: {
                  url: {{ .s3_url }},
                  bucket: test,
                  key: bundle.tar.gz,
                  region: mock-region,
                }
              },
              requirements: [{source: TestApp}]
            }
          },
          sources: {
            TestApp: {
              datasources: [
                {
                  name: "datasource1",
                  path: "datasource1",
                  type: "http",
                  config: {
                    url: {{ .http_url }}/datasource1
                  }
                }
              ],
              files: {
                "app/app.rego": {{ base64encode .app_rego }},
                "foo.rego": {{ base64encode .foo_rego }}
              },
              requirements: [
                {source: TestLibrary}
              ]
            },
            TestLibrary: {
              datasources: [
              {
                  name: "datasource2",
                  path: "datasource2",
                  type: "http",
                  config: {
                    url: {{ .http_url }}/datasource2
                  }
                }
              ],
              files: {
                "bar.rego": {{ base64encode .bar_rego }},
                "lib/lib.rego": {{ base64encode .lib_rego }}
              }
            }
          }
        }
  content_parameters:
    app_rego: &app_rego "package app\np := data.lib.q"
    bar_rego: &bar_rego "package lib\ns := true"
    foo_rego: &foo_rego "package foo"
    lib_rego: &lib_rego "package lib\nq := data.lib.s"
    datasource1_json: &datasource1_json '{"key": "value1"}'
    datasource2_json: &datasource2_json '{"key": "value2"}'
  http_endpoints:
    /datasource1: *datasource1_json
    /datasource2: *datasource2_json
  expected_filesystem:
  - "/651b945976b07287063e8967060724a4/sources/TestApp/database/app/app.rego"
  - "/651b945976b07287063e8967060724a4/sources/TestApp/database/foo.rego"
  - "/651b945976b07287063e8967060724a4/sources/TestApp/datasources/datasource1/data.json"
  - "/651b945976b07287063e8967060724a4/sources/TestLibrary/database/bar.rego"
  - "/651b945976b07287063e8967060724a4/sources/TestLibrary/database/lib/lib.rego"
  - "/651b945976b07287063e8967060724a4/sources/TestLibrary/datasources/datasource2/data.json"
  expected_bundle:
    rego:
      TestApp/app/app.rego: *app_rego
      TestApp/foo.rego: *foo_rego
      TestLibrary/bar.rego: *bar_rego
      TestLibrary/lib/lib.rego: *lib_rego
    data: |
        {
          "datasource1": {{ .datasource1_json }},
          "datasource2": {{ .datasource2_json }}
        }
