exec $OPACTL run --addr ./ocp.sock --config config.d/bundle.yml --data-dir tmp-api-prefix &opactl&
! stderr .
! stdout .

exec curl --retry 5 --retry-all-errors --unix-socket ocp.sock http://localhost/my/api/health
stdout '\{\}'

exec curl --retry 5 --retry-all-errors --unix-socket ocp.sock -H 'Authorization: Bearer admin-token' http://localhost/my/api/v1/bundles
stdout '\{\}'

exec curl --retry 5 --retry-all-errors --unix-socket ocp.sock -H 'Authorization: Bearer admin-token' http://localhost/my/api/v1/sources
stdout '\{\}'

exec curl --retry 5 --retry-all-errors --unix-socket ocp.sock -H 'Authorization: Bearer admin-token' http://localhost/my/api/v1/stacks

exec curl --retry 5 --retry-all-errors --unix-socket ocp.sock http://localhost/my/api/metrics
stdout '/my/api'

! exec curl -f --retry 1 --retry-all-errors --unix-socket ocp.sock http://localhost/health
! exec curl -f --retry 1 --retry-all-errors --unix-socket ocp.sock -H 'Authorization: Bearer admin-token' http://localhost/v1/bundles

kill opactl

-- config.d/bundle.yml --
tokens:
  admin:
    api_key: admin-token
    scopes:
    - role: administrator
service:
  api_prefix: /my/api
